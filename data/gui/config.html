<!DOCTYPE html>
<html>
    <head>
        <style>
            input:invalid{
                border: 2px solid red;
            }
            input:valid{
                border: 2px solid green;
            }

            tr.ends td{
                border-bottom:2px solid #000
            }
        </style>
        <title>BTM Wildfire - BlueKluntje</title>
    </head>
    <body>
        <h1>Config Page</h1>
        <form>
            <table>
                <tr>
                    <td>
                        <label for="wifi_ap_ssid">Wifi ap ssid:</label>
                    </td>
                    <td>
                        <input type="text" id="wifi_ap_ssid" name="wifi_ap_ssid" pattern=".{5,}">            
                    </td>
                </tr>
                <tr class="ends">
                    <td>
                        <label for="wifi_ap_password">Wifi ap password:</label>
                    </td>
                    <td>
                        <input type="text" id="wifi_ap_password" name="wifi_ap_password" pattern=".{5,}">            
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="wifi_private_ssid">Wifi private ssid:</label>
                    </td>
                    <td>
                        <input type="text" id="wifi_private_ssid" name="wifi_private_ssid" pattern=".{5,}">            
                    </td>
                </tr>
                <tr class="ends">
                    <td>
                        <label for="wifi_private_password">Wifi private password:</label>
                    </td>
                    <td>
                        <input type="text" id="wifi_private_password" name="wifi_private_password" pattern=".*">            
                    </td>
                </tr>
                <tr class="ends">
                    <td>
                        <label for="odometer">Odometer (km x10)</label>
                    </td>
                    <td>
                        <input type="text" id="odometer" name="odometer" pattern="[0-9]{1,8}">            
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="bat0_address">BMS 0 mac-address:</label>
                    </td>
                    <td>
                        <input type="text" id="bat0_address" name="bat0_address" pattern="([0-9a-fA-F]{2}:){5}[0-9a-fA-F]{2}">            
                        <label for="bat0_en">enabled?</label>
                        <input type="checkbox" id="bat0_en" name="bat0_en">
                    </td>
                </tr>
                <tr class="ends">
                    <td>
                        <label for="bat1_address">BMS 1 mac-address:</label>
                    </td>
                    <td>
                        <input type="text" id="bat1_address" name="bat1_address">
                        <label for="bat1_en">enabled?</label>
                        <input type="checkbox" id="bat1_en" name="bat1_en">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="ctrl_serial">Serial-Number (JSW...) of Fardriver Controller:</label>
                    </td>
                    <td>
                        <input type="text" id="ctrl_serial" name="ctrl_serial" value="">
                        <label for="ctrl_en">enabled?</label>
                        <input type="checkbox" id="ctrl_en" name="ctrl_en">
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="ctrl_bt_name">Bluetooth name of Fardriver Controller:</label>
                    </td>
                    <td>
                        <input type="text" id="ctrl_bt_name" name="ctrl_bt_name" value="">
                    </td>
                </tr>
                <tr>
                    <td colspan=2><button type="button" id="sendbutton" onClick="sendData()">save</button></td>
                </tr>
            </table>
        </form>
        <script>
            var base_url = `http://${window.location.hostname}`;
            console.log(base_url);
            //base_url ="http://192.168.11.85/";

            function onload(){
                fetch(base_url+'/get_config', {
                    method: 'GET'
                })
                .then((response) => response.json())
                .then((d) => {

                    console.log(d)

                    document.querySelector("#odometer").value=d.odometer;

                    document.querySelector("#wifi_ap_ssid").value=d.wifi_ap_ssid;
                    document.querySelector("#wifi_ap_password").value=d.wifi_ap_password;

                    document.querySelector("#wifi_private_ssid").value=d.wifi_private_ssid;
                    document.querySelector("#wifi_private_password").value=d.wifi_private_password;

                    document.querySelector("#ctrl_serial").value=d.ctrl_serial;
                    document.querySelector("#ctrl_bt_name").value=d.ctrl_bt_name;
                    document.querySelector("#ctrl_en").checked=d.ctrl_enabled;
                    for(i=0;i<d.batteries.length;i++){
                        document.querySelector("#bat"+i+"_address").value=d.batteries[i].address;
                        document.querySelector("#bat"+i+"_en").checked=d.batteries[i].enabled;
                    }
                });
            }
            
            function sendData(){
                var formData = new FormData( document.querySelector("form") )
                
                data = Object.fromEntries(formData)
                console.log(data)
                var jdata={}

                jdata["wifi_ap_ssid"]=data["wifi_ap_ssid"];
                jdata["wifi_ap_password"]=data["wifi_ap_password"];

                jdata["wifi_private_ssid"]=data["wifi_private_ssid"];
                jdata["wifi_private_password"]=data["wifi_private_password"];

                jdata.batteries=[];
                for(i=0;i<2;i++){
                    jdata["batteries"][i]={}
                    jdata["batteries"][i].address=data["bat"+i+"_address"]
                    if(data["bat"+i+"_en"] == undefined){
                        jdata["batteries"][i].enabled = false 
                    }else{
                        jdata["batteries"][i].enabled = true 
                    }
                }
                jdata["controller"]={}
                jdata["controller"]["serial"]=data["ctrl_serial"];
                jdata["controller"]["bt_name"]=data["ctrl_bt_name"];
                if(data["ctrl_en"] == undefined){
                        jdata["controller"].enabled = false 
                    }else{
                        jdata["controller"].enabled = true
                }

                console.log(jdata)


                let json=JSON.stringify(jdata);
                fetch(base_url+'/update_config', {
                    method: 'POST',
                    body: json
                }).then((response) => { 
                // do something with response here... 
                });
            }
            
            window.addEventListener('load', onload);
            
            
        </script>
    </body>
</html>
